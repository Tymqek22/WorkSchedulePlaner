@using WorkSchedulePlaner.Application.DTOs
@model ShiftTileDto

<div class="card">
	<div class="card-header text-center">
		<h3 class="card-title">Add Shift Tile</h3>
	</div>
	<div class="card-body">
		<form method="post" class="row">
			<div class="form-floating mb-2">
				<input class="form-control" id="floatingTitle" asp-for="Title" />
				<label for="floatingTitle" class="ms-2">Title</label>
			</div>
			<div class="form-floating mb-2">
				<input class="form-control" id="floatingDescription" asp-for="Description" />
				<label for="floatingDescription" class="ms-2">Description</label>
			</div>

			<div id="itemsContainer"></div>

			<button type="button" class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#employeeModal">
				Add Employee
			</button>

			<input type="hidden" asp-for="Date" value="@ViewBag.Date" />

			<div class="d-flex justify-content-center gap-4">
				<button type="submit" asp-route-scheduleId="@ViewBag.ScheduleId" class="btn btn-success w-100">
					<i class="bi bi-plus-circle"></i>
					Add Shift
				</button>
				<a class="btn btn-danger w-100" asp-controller="Schedule" asp-action="Details" 
				asp-route-id="@ViewBag.ScheduleId">
					<i class="bi bi-x-circle"></i>
					Cancel
				</a>
			</div>
			
		</form>
	</div>
</div>

<div class="modal fade" id="employeeModal" tabindex="-1" aria-labelledby="employeeModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="employeeModalLabel">Add Employee</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form class="form-control" method="post" id="employeeForm">
					<select class="form-select mb-2" id="selectEmployee" asp-items="@ViewBag.Employees">
						<option>--Select Employee--</option>
					</select>

					<div class="d-flex justify-content-center gap-5">
						<div class="form-floating mb-2">
							<input class="form-control" type="time" id="startTime" />
							<label for="startTime" class="ms-2">Start Time</label>
						</div>
						<div class="form-floating mb-2">
							<input class="form-control" type="time" id="endTime" />
							<label for="endTime" class="ms-2">End Time</label>
						</div>
					</div>
					
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				<button type="button" class="btn btn-success" id="addEmployee" data-bs-dismiss="modal">Add</button>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<script>
		let index = 0;

		document.getElementById("addEmployee").addEventListener("click", function () {

			const employeeId = document.getElementById("selectEmployee").value;
			const startTime = document.getElementById("startTime").value;
			const endTime = document.getElementById("endTime").value;

			const container = document.getElementById("itemsContainer");
			const itemId = `item-${index}`;
			const itemHtml = `
					<div id="${itemId}" class="subitem">
						<input class="form-control subitem" value="${employeeId} | ${startTime} | ${endTime}" disabled readonly/>
						<input type="hidden" name="Shifts[${index}].Employee.Id" value="${employeeId}" />
						<input type="hidden" name="Shifts[${index}].StartTime" value="${startTime}" />
						<input type="hidden" name="Shifts[${index}].EndTime" value="${endTime}" />
						<button type="button" class="btn btn-danger remove-btn" onclick="removeItem('${itemId}')">Delete</button>
					</div>
			`;

			container.insertAdjacentHTML("beforeend",itemHtml);
			index++;

			document.getElementById("selectEmployee").selectedIndex = 0;
			document.getElementById("startTime").value = "";
			document.getElementById("endTime").value = "";
		});

		function removeItem(id) {
			const element = document.getElementById(id);

			if (element) {
				element.remove();
				reindexItems();
			}
		}

		function reindexItems() {
				const items = document.querySelectorAll('#itemsContainer .subitem');

		items.forEach((item, index) => {
			const inputs = item.querySelectorAll('input');

			inputs.forEach(input => {
				const parts = input.name.split('.');
				const propertyName = parts[parts.length - 1];
				input.name = `Shifts[${index}].${propertyName}`;
			});
		});
		}
	</script>
}
